<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FYP Insights Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14">
  <link rel="icon" href="data:,">

  <!-- SEO -->
  <meta name="description" content="Live TikTok Shop viral leaderboard ranked by views & velocity. First 15 free. Clean embeds, pro filtering ‚Äî upgrade for full access." />
  <meta name="robots" content="index,follow">
  <link id="canonicalLink" rel="canonical" href="/" />
  <meta property="og:type" content="website">
  <meta property="og:title" content="FYP Insights Pro">
  <meta property="og:description" content="Track the most viral TikTok Shop videos by performance.">
  <meta property="og:url" content="" id="ogUrlMeta">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="FYP Insights Pro">
  <meta name="twitter:description" content="Live-ranked TikTok Shop videos with views and velocity.">

  <!-- Performance hints -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://docs.google.com">
  <link rel="preconnect" href="https://www.tiktok.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.tiktok.com">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>

  <style>
    :root{
      --bg:#0b0f14; --surface:rgba(21,27,33,.75); --card:#0f141b; --border:#1e2a35;
      --text:#e8eef6; --muted:#9fb0c2; --accent:#6fe3ff; --accent2:#32c8f0;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --btn-bg:linear-gradient(180deg,#111827,#0b1220);
    }
    [data-theme="light"]{
      --bg:#f7f9fc; --surface:rgba(255,255,255,.9); --card:#fff; --border:#e6ecf2;
      --text:#0f1720; --muted:#5b6b7c; --accent:#007aff; --accent2:#0a67e5; --shadow:0 10px 30px rgba(0,0,0,.10);
      --btn-bg:linear-gradient(180deg,#ffffff,#f3f4f6);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.55 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg,rgba(10,14,18,.92),rgba(10,14,18,.75));border-bottom:1px solid var(--border)}
    [data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.85))}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 6px 20px rgba(111,227,255,.22)}
    h1{margin:0;font-size:15px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Mobile filter button (left of Tools) */
    .filter-mobile{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--surface);border:1px solid var(--border);color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer
    }
    @media (min-width:900px){ .filter-mobile{display:none} }

    /* Tools dropdown */
    .tools{position:relative}
    .tools-btn{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--surface);border:1px solid var(--border);color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer
    }
    .tools-btn svg{width:14px;height:14px;opacity:.8}
    .menu{
      position:absolute;top:110%;left:0;min-width:180px;display:none;
      background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;z-index:60;
    }
    .menu a{
      display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;color:var(--text);font-weight:700;font-size:13px;
    }
    .menu a:hover{background:rgba(255,255,255,.04)}
    .tools.open .menu{display:block}

    /* Quick actions (desktop-only icons) */
    .quick{display:flex;gap:8px;align-items:center}
    .round{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:var(--surface);border:1px solid var(--border);font-size:16px;cursor:pointer}
    .round:active{transform:scale(.98)}
    @media (max-width:899px){ .quick{display:none} }

    /* Tagline */
    .hero{max-width:1200px;margin:0 auto;padding:8px 12px 6px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .tagline{font-size:clamp(16px,4.5vw,20px);font-weight:800;letter-spacing:-.01em}
    .subtle{color:var(--muted);font-size:12px}

    /* Status */
    .status{color:var(--muted);font-size:13px;padding:8px 12px;text-align:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00))}

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    @media (min-width:768px){ .wrap{padding:16px} }

    .section-title{display:inline-block;margin:4px auto 12px;padding:6px 14px;border-radius:999px;
      background:var(--surface);border:1px solid var(--border);font-size:13px;font-weight:800}

    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:900px){ .grid{grid-template-columns:repeat(2, minmax(0,1fr));gap:16px} }

    .card{position:relative;background:var(--card);border:1px solid var(--border);
      border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}

    .embed{position:relative;aspect-ratio:9/16;background:#000;overflow:hidden}
    .embed iframe{position:absolute;left:50%;top:50%;width:100%;height:100%;border:0;background:#000;transform:translate(-50%,-50%) scale(1.12)}
    @media (max-width:900px){ .embed iframe{transform:translate(-50%,-50%) scale(1.18)} }

    .skeleton{width:100%;height:100%;background:linear-gradient(90deg,#0f151c 0%,#121a23 50%,#0f151c 100%);background-size:200% 100%;animation:shimmer 1.25s infinite linear}
    @keyframes shimmer{0%{background-position:0 0}100%{background-position:-200% 0}}

    /* Interaction guard + unlock */
    .guard{position:absolute;inset:0;z-index:2;cursor:pointer}
    .unlock{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);z-index:3;background:var(--btn-bg);color:var(--text);
      border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;font-weight:800}
    .unlocked-badge{position:absolute;top:8px;left:8px;z-index:3;background:rgba(0,0,0,.6);color:#fff;border:1px solid rgba(255,255,255,.25);
      border-radius:999px;padding:3px 8px;font-size:10px;display:none}
    .embed.unlocked .unlocked-badge{display:block}

    /* One-time in-video help tip */
    .hint{
      position:absolute;top:8px;right:8px;z-index:4;display:flex;align-items:center;gap:8px;
      background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.24);border-radius:12px;
      padding:6px 10px;font-size:12px;backdrop-filter:saturate(120%) blur(3px)
    }
    .hint button{background:transparent;border:0;color:#fff;font-weight:800;font-size:14px;cursor:pointer}

    /* Blur for paywall-locked items */
    .locked{position:relative}
    .locked::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(11,15,20,.15), rgba(11,15,20,.6)), repeating-linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 1px, transparent 8px);
      backdrop-filter: blur(6px);
      z-index:4; pointer-events:none;
    }
    .locked .lock-overlay{
      position:absolute; inset:auto 8px 8px 8px; z-index:5;
      display:flex; align-items:center; justify-content:center; gap:8px;
      padding:8px 10px; border-radius:12px; background:var(--surface); border:1px solid var(--border);
      font-size:12px; font-weight:800; color:var(--text);
    }

    .meta{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid var(--border)}
    .meta .muted{color:var(--muted);font-size:12px}
    .meta .count{font-weight:800;font-size:12px}

    .actions{display:flex;gap:8px;padding:0 10px 10px}
    .action{font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--surface)}

    .error{display:none;margin:12px;padding:10px 12px;border:1px solid #6a2a2a;background:#2a1515;border-radius:12px;color:#ffbcbc}
    [data-theme="light"] .error{border-color:#fca5a5;background:#fee2e2;color:#7f1d1d}

    footer{color:var(--muted);text-align:center;padding:14px 12px;font-size:12px;border-top:1px solid var(--border)}

    /* PAYWALL modal */
    #paywall{position:fixed;inset:0;z-index:1000;display:none;align-items:center;justify-content:center;padding:16px;
      background:linear-gradient(180deg,rgba(7,10,13,.92),rgba(7,10,13,.92))}
    #paywall .card{width:min(540px,94vw);background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:0 18px 50px rgba(0,0,0,.45);padding:16px}
    #paywall h3{margin:0 0 6px 0;font-size:18px}
    #paywall p{margin:0 0 12px 0;color:var(--muted)}
    #paywall .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    #paywall .bye{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 12px;cursor:pointer}
    .pay-cta{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;font-weight:800;font-size:14px;
      background:linear-gradient(180deg,var(--accent),var(--accent2));color:#001018;border:1px solid color-mix(in oklab, var(--border), var(--accent) 30%);text-decoration:none;white-space:nowrap}

    /* Sticky CTA (mobile) */
    .sticky-cta{position:sticky;bottom:0;z-index:45;padding:10px 12px;background:linear-gradient(180deg,rgba(10,14,18,.0),rgba(10,14,18,.88));
      display:none;border-top:1px solid var(--border)}
    .sticky-cta .pay-cta{width:100%}
    @media (max-width:900px){ .sticky-cta{display:block} }

    /* Desktop upgrade ribbon (subtle) */
    .upgrade-ribbon{display:none}
    @media (min-width:900px){
      .upgrade-ribbon{display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border);
        background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00))}
      .upgrade-ribbon .pay-cta{padding:8px 12px;font-size:13px;border-radius:10px}
      .upgrade-ribbon .muted{color:var(--muted);font-size:12px}
    }

    /* FILTER SHEET */
    #filterSheet{position:fixed;inset:0;z-index:60;display:none}
    #filterSheet.show{display:block}
    .sheet-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .sheet-card{position:absolute;left:0;right:0;bottom:0;background:var(--surface);border-top:1px solid var(--border);border-radius:16px 16px 0 0;box-shadow:0 -12px 40px rgba(0,0,0,.45);padding:14px}
    .sheet-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .select,.btn{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;font-size:13px}
    .sheet-form{display:grid;grid-template-columns:1fr;gap:10px}
    .sheet-actions{display:flex;gap:10px;justify-content:space-between;margin-top:8px}
    .sheet .select,.sheet .btn{width:100%}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>FYP Insights Pro</h1>
      </div>

      <!-- MOBILE: Filters (to the left of Tools) -->
      <button id="filtersBtn" class="filter-mobile" aria-haspopup="dialog" aria-controls="filterSheet" title="Filters">‚öôÔ∏è Filters</button>

      <!-- Tools dropdown -->
      <div class="tools" id="tools">
        <button class="tools-btn" id="toolsBtn" aria-haspopup="true" aria-expanded="false">
          Tools
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="menu" role="menu" aria-label="Tools">
          <a href="/leaderboard" role="menuitem">Leaderboard</a>
          <a href="/hooks" role="menuitem">Hooks</a>
        </div>
      </div>

      <!-- Desktop quick icons: theme + filters -->
      <div class="quick">
        <button id="themeBtn" class="round" title="Toggle theme">üåô</button>
        <button id="filtersBtnDesk" class="round" title="Filters">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <div class="hero">
    <div class="tagline">Spot winners. Post smarter. Grow faster.</div>
    <div class="subtle">15 free videos ‚Ä¢ unlimited with Pro</div>
  </div>

  <!-- Subtle desktop upgrade ribbon -->
  <div class="upgrade-ribbon">
    <span class="muted">Free preview: 15 videos visible. Unlock full access for unlimited scroll.</span>
    <a class="pay-cta" target="_blank" rel="noopener" href="https://buy.stripe.com/7sYaEY72R73w7sn4pT3Je01">Unlock full access ‚Üí</a>
  </div>

  <!-- Sticky CTA (mobile) -->
  <div class="sticky-cta">
    <a class="pay-cta" target="_blank" rel="noopener" href="https://buy.stripe.com/7sYaEY72R73w7sn4pT3Je01">Unlock full access ‚Üí</a>
  </div>

  <!-- FILTER SHEET -->
  <div id="filterSheet" class="sheet" role="dialog" aria-modal="true" aria-label="Filters">
    <div class="sheet-backdrop" data-close></div>
    <div class="sheet-card">
      <div class="sheet-title">
        <strong>Filters</strong>
        <button class="round" data-close title="Close">‚úï</button>
      </div>
      <div class="sheet-form">
        <select id="limitM" class="select" aria-label="Top limit">
          <option value="20" selected>Top 20</option>
          <option value="50">Top 50</option>
          <option value="100">Top 100</option>
        </select>
        <select id="windowM" class="select" aria-label="Time window">
          <option value="24">Last 24h</option>
          <option value="48">Last 48h</option>
          <option value="72">Last 3 days</option>
          <option value="120">Last 5 days</option>
          <option value="168" selected>Last 7 days</option>
          <option value="99999">All</option>
        </select>
        <select id="sortM" class="select" aria-label="Sort order">
          <option value="views" selected>Sort: Total views</option>
          <option value="velocity">Sort: Views/hour</option>
          <option value="date">Sort: Newest</option>
        </select>
      </div>
      <div class="sheet-actions">
        <button class="btn" id="applyFiltersM">Apply</button>
        <button class="btn" id="refreshBtnM">Refresh now</button>
      </div>
    </div>
  </div>

  <div id="status" class="status">Loading‚Ä¶</div>
  <div id="err" class="error"></div>

  <main class="wrap">
    <div id="sectionTitle" class="section-title">Top 20</div>
    <section id="grid" class="grid"></section>
    <div id="empty" style="display:none; color:var(--muted); text-align:center; padding:30px 12px">
      <div>Nothing to show for this window.</div>
      <small>Try ‚ÄúAll‚Äù or ‚ÄúLast 7 days‚Äù, or hit Refresh.</small>
    </div>
  </main>

  <footer>Data from your Google Sheet ‚Ä¢ Embeds lazy-load for speed</footer>

  <!-- PAYWALL MODAL -->
  <div id="paywall" role="dialog" aria-modal="true" aria-label="Upgrade">
    <div class="card">
      <h3>Unlock full access</h3>
      <p>Get unlimited scrolling, all recent videos, and priority refresh.</p>
      <div class="row">
        <a class="pay-cta" target="_blank" rel="noopener"
           href="https://buy.stripe.com/7sYaEY72R73w7sn4pT3Je01">Upgrade now ‚Üí</a>
        <button class="bye" id="maybeLater">Maybe later</button>
      </div>
    </div>
  </div>

  <!-- JSON-LD shells -->
  <script id="ldWebsite" type="application/ld+json">
  { "@context":"https://schema.org", "@type":"WebSite", "name":"FYP Insights ‚Äî TikTok Shop Top Videos", "url":"" }
  </script>
  <script id="ldItemList" type="application/ld+json">{}</script>

  <script>
    // ====== CONFIG ======
    const CSV_URL   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTOWwmQa-QnQ1taKFyJwlMT7e1MgK6OwvhsU0wqsD6NMkHWFU2MFxBBEOFyLgBYfdWpAGEI7Ok8Qln/pub?gid=1654554371&single=true&output=csv";
    const STRIPE_URL= "https://buy.stripe.com/7sYaEY72R73w7sn4pT3Je01";

    const PAYWALL_ENABLED = true;
    const FREE_VISIBLE    = 15; // free visible cards
    const ACTION_LIMIT    = 5;  // optional: show modal after N interactions
    const ACTION_KEY      = 'fyp_actions_v1';
    const MODAL_KEY       = 'fyp_modal_shown_v1';
    const HINT_KEY        = 'fyp_hint_shown_v1';
    const THEME_KEY       = 'theme';

    // ====== STATE ======
    const state = {
      limit: 20,
      windowH: 168,   // default 7 days
      sort: 'views'   // views | velocity | date
    };

    // ====== EL REFS ======
    const els = {
      grid: document.getElementById('grid'),
      status: document.getElementById('status'),
      err: document.getElementById('err'),
      empty: document.getElementById('empty'),
      sectionTitle: document.getElementById('sectionTitle'),
      paywall: document.getElementById('paywall'),
      laterBtn: document.getElementById('maybeLater'),

      // filters
      sheet: document.getElementById('filterSheet'),
      limitM: document.getElementById('limitM'),
      windowM: document.getElementById('windowM'),
      sortM: document.getElementById('sortM'),
      applyFiltersM: document.getElementById('applyFiltersM'),
      refreshBtnM: document.getElementById('refreshBtnM'),

      // header icons
      themeBtn: document.getElementById('themeBtn'),
      filtersBtnDesk: document.getElementById('filtersBtnDesk'),
      filtersBtnMobile: document.getElementById('filtersBtn'),

      // tools menu
      tools: document.getElementById('tools'),
      toolsBtn: document.getElementById('toolsBtn'),
    };

    // ====== SEO canonical ======
    (function(){
      const href = location.origin + location.pathname;
      const canon = document.getElementById('canonicalLink');
      const ogUrl = document.getElementById('ogUrlMeta');
      if (canon) canon.href = href;
      if (ogUrl) ogUrl.setAttribute('content', href);
      try {
        const ld = document.getElementById('ldWebsite');
        const data = JSON.parse(ld.textContent || '{}');
        data.url = href;
        ld.textContent = JSON.stringify(data);
      } catch(_) {}
    })();

    // ====== THEME ======
    function setTheme(mode){
      document.documentElement.setAttribute('data-theme', mode === 'light' ? 'light' : 'dark');
      localStorage.setItem(THEME_KEY, mode);
      if (els.themeBtn) els.themeBtn.textContent = (mode === 'light' ? '‚òÄÔ∏è' : 'üåô');
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY) || 'dark';
      setTheme(saved);
      if (els.themeBtn){
        els.themeBtn.addEventListener('click', ()=>{
          const curr = localStorage.getItem(THEME_KEY) || 'dark';
          setTheme(curr === 'dark' ? 'light' : 'dark');
        });
      }
    }

    // ====== TOOLS MENU ======
    function initToolsMenu(){
      if (!els.tools || !els.toolsBtn) return;
      function close(){ els.tools.classList.remove('open'); els.toolsBtn.setAttribute('aria-expanded','false'); }
      function open(){ els.tools.classList.add('open'); els.toolsBtn.setAttribute('aria-expanded','true'); }
      els.toolsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); (els.tools.classList.contains('open')?close():open()); });
      document.addEventListener('click', (e)=>{ if (!els.tools.contains(e.target)) close(); });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); });
    }

    // ====== ACTION COUNTER / PAYWALL ======
    const getActions = () => parseInt(localStorage.getItem(ACTION_KEY)||'0',10) || 0;
    function addAction(n=1){
      if (!PAYWALL_ENABLED) return;
      const v = getActions()+n;
      localStorage.setItem(ACTION_KEY, String(v));
      if (v >= ACTION_LIMIT) showPaywall();
    }
    function showPaywall(){
      if (!PAYWALL_ENABLED) return;
      if (!els.paywall) return;
      const shown = sessionStorage.getItem(MODAL_KEY)==='1';
      if (!shown){
        els.paywall.style.display='flex';
        sessionStorage.setItem(MODAL_KEY,'1');
      }
    }
    function hidePaywall(){ if (els.paywall) els.paywall.style.display='none'; }

    // ====== UTILS ======
    const fmtViews = n => { const x = Number(n)||0;
      if (x >= 1e9) return (x/1e9).toFixed(1)+'B';
      if (x >= 1e6) return (x/1e6).toFixed(1)+'M';
      if (x >= 1e3) return (x/1e3).toFixed(1)+'K';
      return x.toLocaleString();
    };
    const fmtDate = iso => { const d = new Date(iso); return isNaN(d) ? (iso||'') :
      d.toLocaleString(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); };
    function showError(msg){ els.err.style.display='block'; els.err.textContent = msg; }
    function clearError(){ els.err.style.display='none'; els.err.textContent=''; }

    // ====== EMBED LOADER ======
    const io = new IntersectionObserver((entries)=>{
      for (const e of entries) if (e.isIntersecting){
        const holder = e.target; io.unobserve(holder);
        if (holder.querySelector('iframe')) continue;
        const sk = holder.querySelector('.skeleton'); if (sk) sk.remove();
        const id = holder.dataset.id;
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.tiktok.com/embed/v2/${id}`;
        iframe.setAttribute('allowfullscreen','');
        iframe.setAttribute('loading','lazy');
        holder.appendChild(iframe);
      }
    }, { rootMargin: '200px 0px' });

    function tryEnableSoundOnce(embed){
      const iframe = embed.querySelector('iframe');
      if (!iframe || iframe.dataset.soundTried === '1') return;
      try{
        const u = new URL(iframe.src);
        u.searchParams.set('autoplay','1');
        u.searchParams.set('mute','0');
        iframe.dataset.soundTried = '1';
        iframe.src = u.toString();
      }catch(_e){}
    }

    // ====== DATA MAP ======
    function normalizeRowByIndex(row){
      const date = (row[0]||'').toString().trim();
      const views = Number((row[1]||'0').toString().replace(/,/g,''));
      const url = (row[2]||'').toString().trim();
      const m = url.match(/\/video\/(\d+)/);
      const id = m ? m[1] : '';
      const t = Date.parse(date);
      const ageH = isNaN(t) ? 1e9 : Math.max((Date.now() - t)/3600000, 0.001);
      const vph = isFinite(ageH) && ageH > 0 ? (views/Math.max(ageH,0.25)) : 0;
      return { date, views, url, id, ageH, vph };
    }

    function updateSectionTitle(){
      els.sectionTitle.textContent = state.limit === 50 ? 'Top 50' : (state.limit === 100 ? 'Top 100' : 'Top 20');
    }

    // ====== One-time hint attachment ======
    function attachHintIfNeeded(embed){
      try{
        if (sessionStorage.getItem(HINT_KEY)==='1') return;
        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.innerHTML = `Tap üîä in the TikTok player to hear audio.<br><strong>Tip:</strong> Use ‚ÄúEnable controls‚Äù to interact. <button aria-label="Dismiss">‚úï</button>`;
        const btn = hint.querySelector('button');
        btn.addEventListener('click', ()=> { hint.remove(); sessionStorage.setItem(HINT_KEY,'1'); });
        embed.appendChild(hint);
      }catch(_){}
    }

    // ====== LOCKED VIEWPORT WATCHER (pop modal when first blurred appears) ======
    let lockIO;
    function watchLocked(){
      if (lockIO) lockIO.disconnect();
      if (!PAYWALL_ENABLED) return;
      lockIO = new IntersectionObserver((entries)=>{
        for (const e of entries){
          if (e.isIntersecting){
            showPaywall();
            lockIO.disconnect();
            break;
          }
        }
      }, { rootMargin: '0px 0px -40% 0px' });
      document.querySelectorAll('.card.locked .embed').forEach(el => lockIO.observe(el));
    }

    // ====== RENDER ======
    function makeCard(r, idx, sortMode){
      const locked = PAYWALL_ENABLED && idx >= FREE_VISIBLE;

      const card = document.createElement('div'); card.className='card' + (locked ? ' locked' : '');
      const embed = document.createElement('div'); embed.className='embed'; embed.dataset.id = r.id;
      embed.innerHTML = `<div class="skeleton"></div>`;
      const guard = document.createElement('div'); guard.className='guard'; embed.appendChild(guard);
      const unlock = document.createElement('button'); unlock.className='unlock'; unlock.innerHTML = `Enable controls for 6s ‚Äî then tap üîä`;
      const badge = document.createElement('div'); badge.className='unlocked-badge'; badge.textContent='Controls unlocked';
      embed.appendChild(unlock); embed.appendChild(badge);

      // Show hint once on the very first visible (unlocked) card
      if (!locked && idx === 0) attachHintIfNeeded(embed);

      if (locked){
        const overlay = document.createElement('div');
        overlay.className = 'lock-overlay';
        overlay.innerHTML = `üîí Locked ‚Äî <a class="pay-cta" target="_blank" rel="noopener" href="${STRIPE_URL}" style="padding:6px 10px;border-radius:10px;font-size:12px">Unlock full access ‚Üí</a>`;
        embed.appendChild(overlay);
      }

      function relock(){ embed.classList.remove('unlocked'); guard.style.display='block'; }
      function unlockFor(ms=6000){
        guard.style.display='none'; embed.classList.add('unlocked'); tryEnableSoundOnce(embed);
        let left = Math.round(ms/1000); badge.textContent = `Tap speaker in the video (${left}s)`;
        const t = setInterval(()=>{ left--; if (left<=0){ clearInterval(t); relock(); } else badge.textContent = `Tap speaker in the video (${left}s)`; },1000);
      }
      unlock.addEventListener('click', (e)=>{ e.stopPropagation(); addAction(); unlockFor(); sessionStorage.setItem(HINT_KEY,'1'); });

      let sx=0, sy=0, moved=false;
      guard.addEventListener('pointerdown', (e)=>{ sx=e.clientX; sy=e.clientY; moved=false; }, {passive:true});
      guard.addEventListener('pointermove', (e)=>{ if (Math.abs(e.clientX-sx)>8 || Math.abs(e.clientY-sy)>8) moved=true; }, {passive:true});
      guard.addEventListener('pointerup', ()=>{ if (!moved){ addAction(); tryEnableSoundOnce(embed); guard.style.pointerEvents='none'; setTimeout(()=>{ guard.style.pointerEvents='auto'; }, 160); sessionStorage.setItem(HINT_KEY,'1'); } }, {passive:true});

      const meta = document.createElement('div'); meta.className='meta';
      const extra = (sortMode === 'velocity') ? ` ‚Ä¢ ‚ö° ${fmtViews(Math.round(r.vph))}/hr` : '';
      meta.innerHTML = `<span class="muted">${fmtDate(r.date)}</span><span class="count">üëÄ ${fmtViews(r.views)}${extra}</span>`;
      const actions = document.createElement('div'); actions.className='actions';
      actions.innerHTML = `<a class="action" target="_blank" rel="noopener" href="${r.url}">Open in TikTok ‚Üó</a>`;

      card.appendChild(embed); card.appendChild(meta); card.appendChild(actions);
      if (!locked) io.observe(embed);
      return card;
    }

    function render(rows){
      const sortMode = state.sort;
      els.grid.innerHTML = ''; els.empty.style.display = 'none';
      if (!rows.length){ els.empty.style.display = 'block'; }
      else{
        const frag = document.createDocumentFragment();
        rows.slice(0, state.limit).forEach((r, i)=> frag.appendChild(makeCard(r, i, sortMode)));
        els.grid.appendChild(frag);
      }
      els.status.textContent = `Showing ${Math.min(rows.length, state.limit)} videos ‚Ä¢ Last updated ${new Date().toLocaleTimeString()}`;

      // JSON-LD ItemList (top 50)
      try{
        const items = Array.from(els.grid.querySelectorAll('.card')).slice(0, 50).map((node, i) => {
          const iframeId = node.querySelector('.embed')?.dataset.id || '';
          const link = node.querySelector('.actions a')?.getAttribute('href') || '';
          return { "@type":"ListItem", "position": i+1, "url": link || (iframeId ? `https://www.tiktok.com/@_/video/${iframeId}` : "") };
        }).filter(x => x.url);
        const ld = { "@context":"https://schema.org", "@type":"ItemList", "itemListElement": items };
        document.getElementById('ldItemList').textContent = JSON.stringify(ld);
      }catch(_e){}

      watchLocked();
    }

    // ====== LOAD ======
    function applyFilters(allRows){
      // time window
      let filtered = state.windowH ? allRows.filter(r => r.ageH <= state.windowH) : allRows.slice();
      if (filtered.length === 0 && state.windowH < 168) filtered = allRows.filter(r => r.ageH <= 168);

      // sort
      if (state.sort === 'views') filtered.sort((a,b)=> b.views - a.views);
      else if (state.sort === 'velocity') filtered.sort((a,b)=> b.vph - a.vph);
      else filtered.sort((a,b)=> new Date(b.date) - new Date(a.date));

      return filtered;
    }

    async function load(){
      clearError(); els.status.textContent = 'Loading‚Ä¶';
      return new Promise((resolve)=>{
        const url = CSV_URL + (CSV_URL.includes('?')?'&':'?') + 'cb=' + Date.now();
        Papa.parse(url, {
          download:true, header:false, skipEmptyLines:true,
          complete: (res)=>{
            try{
              const raw = res.data || [];
              const startIdx = (raw[0] && (''+raw[0][0]).toLowerCase().includes('upload')) ? 1 : 0;
              const seen = new Set(); let rows = [];
              for (let i = startIdx; i < raw.length; i++) {
                const r = normalizeRowByIndex(raw[i]);
                if (!r.id || !/tiktok\.com\/@.+\/video\/\d+/.test(r.url)) continue;
                if (seen.has(r.id)) continue; seen.add(r.id);
                rows.push(r);
              }
              updateSectionTitle();
              render(applyFilters(rows));
              resolve();
            }catch(e){ showError('Parse/render error: '+e.message); resolve(); }
          },
          error: (err)=> { showError('Failed to fetch CSV: ' + (err?.message || err)); resolve(); }
        });
      });
    }

    // ====== FILTER SHEET ======
    function openSheet(){ els.sheet.classList.add('show'); }
    function closeSheet(){ els.sheet.classList.remove('show'); }
    function initFilterSheet(){
      if (els.filtersBtnDesk) els.filtersBtnDesk.addEventListener('click', openSheet);
      if (els.filtersBtnMobile) els.filtersBtnMobile.addEventListener('click', openSheet);
      if (els.sheet) els.sheet.addEventListener('click', (e)=>{ if (e.target.matches('[data-close], .sheet-backdrop')) closeSheet(); });
      if (els.applyFiltersM) els.applyFiltersM.addEventListener('click', ()=>{
        state.limit   = parseInt(els.limitM.value,10) || 20;
        state.windowH = parseInt(els.windowM.value,10) || 168;
        state.sort    = els.sortM.value || 'views';
        updateSectionTitle();
        addAction();
        load();
        closeSheet();
      });
      if (els.refreshBtnM) els.refreshBtnM.addEventListener('click', ()=>{ addAction(); load(); });
    }

    // ====== INIT (wait for Papa to be ready) ======
    function initSEO(){
      const href = location.origin + location.pathname;
      const canon = document.getElementById('canonicalLink');
      const ogUrl = document.getElementById('ogUrlMeta');
      if (canon) canon.href = href;
      if (ogUrl) ogUrl.setAttribute('content', href);
    }

    function initPaywall(){
      if (els.laterBtn) els.laterBtn.addEventListener('click', hidePaywall);
      document.querySelectorAll('.pay-cta').forEach(a=>{
        a.addEventListener('click', ()=> { sessionStorage.setItem(MODAL_KEY,'1'); hidePaywall(); });
      });
    }

    async function init(){
      initTheme();
      initToolsMenu();
      initFilterSheet();
      initPaywall();
      initSEO();
      await load();
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
