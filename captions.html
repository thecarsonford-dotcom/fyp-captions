<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Caption Catalyst — FYP Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14">
  <link rel="icon" href="data:,">
  <meta name="description" content="AI-powered TikTok caption and hashtag generator. Broad + niche strategy, tuned for FYP.">

  <style>
    :root{
      --bg:#0b0f14; --surface:rgba(21,27,33,.75); --card:#0f141b; --border:#1e2a35;
      --text:#e8eef6; --muted:#9fb0c2; --accent:#6fe3ff; --accent2:#32c8f0;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); --btn-bg:linear-gradient(180deg,#111827,#0b1220);
    }
    [data-theme="light"]{
      --bg:#f7f9fc; --surface:rgba(255,255,255,.9); --card:#fff; --border:#e6ecf2;
      --text:#0f1720; --muted:#5b6b7c; --accent:#007aff; --accent2:#0a67e5; --shadow:0 10px 30px rgba(0,0,0,.10);
      --btn-bg:linear-gradient(180deg,#ffffff,#f3f4f6);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.55 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg,rgba(10,14,18,.92),rgba(10,14,18,.75));border-bottom:1px solid var(--border)}
    [data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.85))}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 6px 20px rgba(111,227,255,.22)}
    h1{margin:0;font-size:15px;font-weight:800;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .tools{position:relative}
    .tools-btn{display:inline-flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);color:var(--text);
      padding:8px 10px;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer}
    .tools-btn svg{width:14px;height:14px;opacity:.8}
    .menu{position:absolute;top:110%;left:0;min-width:180px;display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:6px;z-index:60}
    .menu a{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;color:var(--text);font-weight:700;font-size:13px}
    .menu a:hover{background:rgba(255,255,255,.04)}
    .tools.open .menu{display:block}

    .quick{display:flex;gap:8px;align-items:center}
    .round{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:var(--surface);border:1px solid var(--border);font-size:16px;cursor:pointer}
    .round:active{transform:scale(.98)}
    @media (max-width:899px){ .quick{display:none} }

    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    @media (min-width:768px){ .wrap{padding:16px} }

    .hero{max-width:1200px;margin:0 auto;padding:10px 12px 8px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .tagline{font-size:clamp(16px,4.5vw,20px);font-weight:800;letter-spacing:-.01em}
    .subtle{color:var(--muted);font-size:12px}

    .panel{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:980px){ .panel{grid-template-columns:360px 1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .card.pad{padding:14px}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    input[type=text], select{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);outline:none;font-size:14px
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-weight:800;cursor:pointer}
    .btn.accent{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#001018;border-color:color-mix(in oklab, var(--border), var(--accent) 30%)}

    .cols{display:grid;gap:12px}
    @media (min-width:680px){ .cols{grid-template-columns: 1fr 340px} }
    .hlist{display:grid;gap:10px}
    .cap{background:linear-gradient(180deg,#0f141b,#0c1116);border:1px solid var(--border);border-radius:12px;padding:12px}
    .cap .meta{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .cap .meta .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a4a;background:#161c22}
    .cap .body{white-space:pre-wrap}
    .cap .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .copy{padding:8px 10px;border-radius:9px;border:1px solid var(--border);background:var(--surface);font-size:12px;cursor:pointer}

    .side{position:sticky;top:86px;align-self:start}
    .box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .muted{color:var(--muted)}
    .kpi{display:flex;justify-content:space-between;font-weight:800}

    .status{color:var(--muted);font-size:13px;padding:8px 12px;text-align:center;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00));display:none}
    .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Caption Catalyst — FYP Edition</h1>
      </div>

      <div class="tools" id="tools">
        <button class="tools-btn" id="toolsBtn" aria-haspopup="true" aria-expanded="false">
          Tools
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <div class="menu" role="menu" aria-label="Tools">
          <a href="/leaderboard" role="menuitem">Leaderboard</a>
          <a href="/hooks" role="menuitem">Hooks</a>
          <a href="/captions" role="menuitem" aria-current="page">Captions</a>
        </div>
      </div>

      <div class="quick">
        <button id="themeBtn" class="round" title="Toggle theme">🌙</button>
      </div>
    </div>
  </header>

  <div class="hero">
    <div class="tagline">Write faster. Rank smarter. Convert harder.</div>
    <div class="subtle">AI-tuned captions & hashtag strategy for TikTok Shop.</div>
  </div>

  <div id="status" class="status">Ready.</div>

  <main class="wrap panel">
    <section class="card pad">
      <div class="row">
        <div style="flex:1; min-width:220px">
          <label>Product / Offer</label>
          <input id="product" type="text" placeholder="e.g., 14-in-1 Veggie Chopper" />
        </div>
        <div style="width:170px">
          <label>Category</label>
          <select id="category" class="input">
            <option value="">— Any —</option>
            <option>beauty</option><option>skincare</option><option>kitchen</option>
            <option>cleaning</option><option>gadgets</option><option>home</option>
            <option>fitness</option><option>fashion</option><option>pets</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:220px">
          <label>Audience / Persona</label>
          <input id="audience" type="text" placeholder="e.g., busy parents; students; renters" />
        </div>
        <div style="flex:1; min-width:220px">
          <label>Primary Goal</label>
          <select id="goal" class="input">
            <option>clicks</option>
            <option>add to cart</option>
            <option>brand awareness</option>
            <option>comments</option>
            <option>follows</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:220px">
          <label>Key pains (semicolon separated)</label>
          <input id="pains" type="text" placeholder="e.g., long prep; streaky pans; cluttered counters" />
        </div>
        <div style="flex:1; min-width:220px">
          <label>Benefits / Outcomes (semicolon)</label>
          <input id="benefits" type="text" placeholder="e.g., 5-min prep; spotless in one pass" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1; min-width:160px">
          <label>Tone</label>
          <select id="tone" class="input">
            <option>bold</option><option>friendly</option><option>luxury</option>
            <option>scientific</option><option>contrarian</option><option>playful</option>
          </select>
        </div>
        <div style="flex:1; min-width:160px">
          <label>Length</label>
          <select id="length" class="input">
            <option>short</option><option selected>medium</option><option>long</option>
          </select>
        </div>
        <div style="flex:1; min-width:160px">
          <label>Emoji level</label>
          <select id="emoji" class="input">
            <option>none</option><option selected>smart</option><option>high</option>
          </select>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="generate" class="btn accent">Generate</button>
        <button id="copyAll" class="btn">Copy all</button>
        <button id="exportCsv" class="btn">Export CSV</button>
      </div>
      <div class="subtle small">Server AI route: <code>/api/generate-captions-edge</code>. Falls back locally if unavailable.</div>
    </section>

    <section class="cols">
      <div class="card pad">
        <div id="list" class="hlist" aria-live="polite"></div>
      </div>

      <aside class="side">
        <div class="box" style="margin-bottom:12px">
          <div class="kpi"><span>Caption length</span><span id="kLen">—</span></div>
          <div class="kpi"><span>Hashtag count</span><span id="kHash">—</span></div>
          <div class="kpi"><span>Variants</span><span id="kVar">—</span></div>
        </div>
        <div class="box">
          <div class="muted small">Best practices baked in:</div>
          <ul class="small" style="margin:6px 0 0 16px;line-height:1.55">
            <li>Hook first, tangible benefit, then CTA.</li>
            <li>Emojis for scannability, not glitter.</li>
            <li>Hashtags: broad + mid + niche (+ branded if relevant).</li>
            <li>Paste-ready line + alternates every run.</li>
          </ul>
        </div>
      </aside>
    </section>
  </main>

  <footer class="wrap" style="text-align:center;color:var(--muted);padding-top:4px;border-top:1px solid var(--border)">
    © <span id="y"></span> FYP Insights Pro — Caption Catalyst
  </footer>

    <script>
  // ========= HARDENED BOOTSTRAP =========
  (function(){
    // Show any runtime error in the status bar so we don't get "nothing happens"
    window.addEventListener('error', (e)=>{
      const s = document.getElementById('status');
      if (s){ s.textContent = 'Script error: ' + (e?.message || 'unknown'); s.style.display='block'; }
    });
  })();

  // ====================== CONFIG ======================
  const THEME_KEY = 'theme';
  const STATE_KEY = 'CAPTION_CATALYST_STATE_V1';
  const API_URL   = '/api/generate-captions-edge'; // <- Edge route we created

  // =================== THEME (same as index) ===================
  function setTheme(mode){
    document.documentElement.setAttribute('data-theme', mode === 'light' ? 'light' : 'dark');
    localStorage.setItem(THEME_KEY, mode);
    const btn = document.getElementById('themeBtn');
    if (btn) btn.textContent = mode === 'light' ? '☀️' : '🌙';
  }
  function initTheme(){
    setTheme(localStorage.getItem(THEME_KEY) || 'dark');
    const btn = document.getElementById('themeBtn');
    if (btn) btn.addEventListener('click', ()=>{
      const cur = localStorage.getItem(THEME_KEY) || 'dark';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });
  }

  // =================== TOOLS MENU ===================
  function initMenu(){
    const tools = document.getElementById('tools');
    const toolsBtn = document.getElementById('toolsBtn');
    if (!tools || !toolsBtn) return;
    function close(){ tools.classList.remove('open'); toolsBtn.setAttribute('aria-expanded','false'); }
    function open(){ tools.classList.add('open'); toolsBtn.setAttribute('aria-expanded','true'); }
    toolsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); (tools.classList.contains('open')?close():open()); });
    document.addEventListener('click', (e)=>{ if (!tools.contains(e.target)) close(); });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); });
  }

  // =================== DOM SHORTCUTS ===================
  const $  = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const strip = (s)=> (s||'').toString().replace(/\s+/g,' ').trim();
  const splitSemi = (s)=> strip(s).split(/\s*;\s*/).filter(Boolean);
  const todaySeed = ()=> new Date().toISOString().slice(0,10);
  const copy = async (txt)=>{ try{ await navigator.clipboard.writeText(txt) }catch{} };

  // =================== DEFAULTS (unchanged) ===================
  const defaultsByCategory = {
    beauty:{ pains:['wasting money on serums','red irritated skin'], benefits:['glass-skin in 7 days','barrier-safe glow'], seed:['skincare','serum'] },
    skincare:{ pains:['acne flares','10-step routines'], benefits:['derm-approved minimal routine'], seed:['skin','glow'] },
    kitchen:{ pains:['spending forever prepping','slippery cutting board'], benefits:['5-min meal prep','one tool replaces 7'], seed:['kitchen','mealprep','cook'] },
    cleaning:{ pains:['streaky mirrors','scrub for 30 minutes'], benefits:['spotless in one pass','zero streaks'], seed:['cleaning','home'] },
    gadgets:{ pains:['dead battery by noon','cables everywhere'], benefits:['all-day battery','one cable'], seed:['tech','gadgets'] },
    home:{ pains:['cluttered counters','no storage'], benefits:['renter-friendly storage'], seed:['home','organize'] },
    fitness:{ pains:['burnout','plateaus'], benefits:['10-min routines','visible progress'], seed:['fitness','workout'] },
    fashion:{ pains:['fits that don’t flatter'], benefits:['tailored look under $50'], seed:['fashion','outfit'] },
    pets:{ pains:['fur on everything'], benefits:['hair-free couch'], seed:['pets','dog'] },
  };

  // Templates / CTAs / Emoji / Hashtag seeds (unchanged)
  const CAP_TPL = [
    "{toneLead}{benefit} without the {pain}. {product} just fixed it.",
    "{toneLead}The fastest path to {benefit}? Start with {product}.",
    "{toneLead}{audience}: if {pain} is your reality, this is your shortcut.",
    "{toneLead}Proof over hype — watch how {product} delivers {benefit}.",
    "{toneLead}I stopped {pain}. {product} in, {benefit} out.",
    "{toneLead}New rule: one change → {benefit}. (It’s {product}.)",
    "{toneLead}Real talk: {benefit} is easy when you remove {pain}.",
    "{toneLead}{goalTitle} mode: do this first. {product} → {benefit}.",
    "{toneLead}Before vs after with {product}. Unfiltered {benefit}.",
    "{toneLead}If you want {benefit}, start here → {product}."
  ];
  const TONE_LEADS = {
    bold:"Hot take: ",
    friendly:"Real talk: ",
    luxury:"Insider tip: ",
    scientific:"Backed by data: ",
    contrarian:"Unpopular opinion: ",
    playful:"Low effort, high win: ",
  };
  const CTAS = {
    clicks: ["Tap to see how it works →", "Link in bio — details inside.", "Want the breakdown? Tap through."],
    "add to cart": ["Grab it while it’s in stock →", "Add to cart before price jumps.", "Don’t wait — check it out now."],
    "brand awareness": ["Follow for more real tests.", "Save this for later.", "Share with a friend who needs this."],
    comments: ["Comment ‘guide’ and I’ll DM the steps.", "What should I test next? Drop it.", "Tried this? Tell me your results."],
    follows: ["Follow for daily shortcuts.", "More like this every day — follow.", "New tests weekly — hit follow."]
  };
  const EMOJI_PACK = {
    none: [], smart: ["⚡️","✅","🧪","🔥","🎯","⏱️","💡","🔒","📦","✨"],
    high: ["🔥","💥","✨","😍","🤯","⚡️","🚀","💡","🧪","🛒","🎯"]
  };
  const BROAD_SEEDS = ["tiktokmademebuyit","fyp","viral","tiktokshop","musthave"];
  const MID_SEEDS   = ["lifehack","unboxing","review","beforeafter","asmr"];
  const CAT_SEEDS   = {
    beauty:["skincare","glowup","acnetips","skinbarrier"],
    skincare:["skincare","barrierrepair","dermtips"],
    kitchen:["kitchen","mealprep","kitchenhacks","homecooking"],
    cleaning:["cleaningtips","cleantok","deepclean","cleaninghacks"],
    gadgets:["gadgets","tech","techtok","setup"],
    home:["homedecor","organize","apartment"],
    fitness:["fitness","workout","homeworkout","fitnesstips"],
    fashion:["fashion","outfit","ootd","capsulewardrobe"],
    pets:["pettok","dogsoftiktok","catsoftiktok","petparents"]
  };

  // =================== STATE ===================
  const els = {};
  function cacheEls(){
    els.product  = $('#product');
    els.category = $('#category');
    els.audience = $('#audience');
    els.goal     = $('#goal');
    els.pains    = $('#pains');
    els.benefits = $('#benefits');
    els.tone     = $('#tone');
    els.length   = $('#length');
    els.emoji    = $('#emoji');
    els.strategy = $('#strategy');
    els.hashCount= $('#hashCount');
    els.list     = $('#list');
    els.kLen     = $('#kLen');
    els.kHash    = $('#kHash');
    els.kVar     = $('#kVar');
    els.status   = $('#status');
    els.generate = document.getElementById('generate');
    els.copyAll  = document.getElementById('copyAll');
    els.exportCsv= document.getElementById('exportCsv');
  }

  function saveState(){
    const s = {
      product: els.product.value, category: els.category.value, audience: els.audience.value, goal: els.goal.value,
      pains: els.pains.value, benefits: els.benefits.value, tone: els.tone.value, length: els.length.value,
      emoji: els.emoji.value, strategy: els.strategy.value, hashCount: els.hashCount.value
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(s));
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY); if (!raw) return;
      const s = JSON.parse(raw);
      els.product.value = s.product||''; els.category.value=s.category||''; els.audience.value=s.audience||'';
      els.goal.value=s.goal||'clicks'; els.pains.value=s.pains||''; els.benefits.value=s.benefits||'';
      els.tone.value=s.tone||'bold'; els.length.value=s.length||'medium'; els.emoji.value=s.emoji||'smart';
      els.strategy.value=s.strategy||'balanced'; els.hashCount.value=s.hashCount||'8';
    }catch{}
  }

  // =================== HELPERS ===================
  function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function clampLen(t, mode){
    if (mode==='short' && t.length>80) return t.split(' ').slice(0,12).join(' ') + '…';
    if (mode==='long'  && t.length<80) return t + ' — here’s why.';
    return t;
  }
  function injectEmoji(t, pack, intensity){
    if (!pack.length || intensity==='none') return t;
    const pick = ()=> sample(pack);
    if (intensity==='smart'){ if (Math.random()<0.7) t = t + ' ' + pick(); if (Math.random()<0.35) t = pick() + ' ' + t; }
    else { t = pick() + ' ' + t + ' ' + pick(); }
    return t;
  }
  function slugifyHash(s){ return strip(s.toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,'')); }

  function makeHashtags({product, category, audience, benefitsPool, painsPool, strategy, hashCount}){
    const n = parseInt(hashCount,10) || 8;
    const broad = [...BROAD_SEEDS], mid=[...MID_SEEDS], cset=CAT_SEEDS[category]||[];
    const terms = []
      .concat((product||'').split(/\W+/))
      .concat((audience||'').split(/\W+/))
      .concat(benefitsPool||[])
      .concat(painsPool||[])
      .map(slugifyHash).filter(x=> x && x.length>2 && x.length<28);
    const niche = new Set();
    terms.forEach(t=>{ niche.add(t); if (Math.random()<0.35) niche.add(t+(Math.random()<0.5?'tips':'hack')); });
    function take(arr,k){ const out=[]; const pool=[...arr]; for(let i=0;i<k&&pool.length;i++){ out.push(pool.splice(Math.floor(Math.random()*pool.length),1)[0]); } return out; }
    let picks = [];
    if (strategy==='niche-heavy'){
      picks = take([...niche], Math.ceil(n*0.6)).concat(take(cset, Math.ceil(n*0.2)), take(mid, Math.ceil(n*0.1)), take(broad, Math.ceil(n*0.1)));
    } else if (strategy==='broad-heavy'){
      picks = take(broad, Math.ceil(n*0.4)).concat(take(mid, Math.ceil(n*0.25)), take(cset, Math.ceil(n*0.2)), take([...niche], Math.ceil(n*0.15)));
    } else if (strategy==='branded'){
      const branded = slugifyHash(product||'brand');
      picks = [branded].concat(take(broad, Math.ceil((n-1)*0.35)), take(mid, Math.ceil((n-1)*0.25)), take(cset, Math.ceil((n-1)*0.2)), take([...niche], Math.ceil((n-1)*0.2)));
    } else {
      picks = take(broad, Math.ceil(n*0.25)).concat(take(mid, Math.ceil(n*0.25)), take(cset, Math.ceil(n*0.25)), take([...niche], Math.ceil(n*0.25)));
    }
    const unique=[], seen=new Set();
    picks.forEach(h=>{ const w=slugifyHash(h); if (!w||seen.has(w)) return; seen.add(w); unique.push('#'+w); });
    return unique.slice(0,n);
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function escAttr(s){ return (s||'').replace(/"/g,'&quot;'); }
  function decodeAttr(s){ const d=document.createElement('div'); d.innerHTML=s; return d.textContent||''; }
  function flash(msg){ els.status.textContent = msg; els.status.style.display='block'; clearTimeout(flash._t); flash._t=setTimeout(()=> els.status.style.display='none', 1500); }

  function render(list, preferCombined){
    const host = els.list; host.innerHTML = '';
    if (preferCombined && list.length){
      const first = list[0];
      const full = (first.combined || (first.caption + (first.hashtags?.length ? '\n'+first.hashtags.join(' ') : ''))).trim();
      const one = document.createElement('div');
      one.className = 'cap';
      one.innerHTML = `
        <div class="meta"><div class="tag">Paste-ready</div><div class="small muted">${full.length} chars</div></div>
        <div class="body">${escapeHtml(full)}</div>
      <div class="actions"><button class="copy" data-payload="${escAttr(full)}">Copy line</button></div>`;
      host.appendChild(one);
    }
    list.forEach((it, i)=>{
      if (preferCombined && i===0) return;
      const cap = it.caption || it.combined || '';
      const tags = (it.hashtags || []).join(' ');
      const box = document.createElement('div');
      box.className = 'cap';
      box.innerHTML = `
        <div class="meta">
          <div class="tag">Option ${preferCombined ? i : i+1}</div>
          <div class="small muted">${cap.length} chars • ${it.hashtags?.length || 0} tags</div>
        </div>
        <div class="body">${escapeHtml(cap)}</div>
        ${tags ? `<div class="body" style="margin-top:6px;color:var(--muted)">${escapeHtml(tags)}</div>`:''}
        <div class="actions">
          <button class="copy" data-payload="${escAttr(cap)}">Copy caption</button>
          ${tags ? `<button class="copy" data-payload="${escAttr(tags)}">Copy hashtags</button>`:''}
          ${tags ? `<button class="copy" data-payload="${escAttr(cap+'\n'+tags)}">Copy both</button>`:''}
        </div>`;
      host.appendChild(box);
    });
    const capsOnly = list.map(x => x.caption || x.combined || '');
    const avgLen = Math.round(capsOnly.reduce((a,c)=>a+(c?.length||0),0) / Math.max(1,capsOnly.length));
    els.kVar.textContent = String(list.length);
    els.kLen.textContent = isFinite(avgLen)? `${avgLen} avg` : '—';
    els.kHash.textContent = list[0]?.hashtags?.length || '—';

    host.querySelectorAll('.copy').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const payload = decodeAttr(btn.getAttribute('data-payload')||'');
        navigator.clipboard.writeText(payload).then(()=> flash('Copied ✅'));
      });
    });
  }

  // ========== API ==========
  async function callAI(vars){
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({
        product: vars.product,
        audience: vars.audience,
        benefits: vars.benefits,
        pains: vars.pains,
        tone: vars.tone,
        length: vars.length,
        platform: 'tiktok',
        count: 6,
        hashCount: parseInt(vars.hashCount,10)||8
      })
    });
    if (!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error(`API ${res.status}: ${txt}`);
    }
    return res.json();
  }

  // ========== CORE FLOW ==========
  function readVars(){
    const product = strip(els.product.value);
    const category = strip(els.category.value);
    const audience = strip(els.audience.value);
    const goal = strip(els.goal.value||'clicks');
    const pains = splitSemi(els.pains.value);
    const benefits = splitSemi(els.benefits.value);
    return {
      product, category, audience, goal, pains, benefits,
      tone: els.tone.value, length: els.length.value, emoji: els.emoji.value,
      strategy: els.strategy.value, hashCount: els.hashCount.value
    };
  }

  function fallbackHashtags({product, category, audience, benefits, pains, n=8}){
    const base = ['fyp','tiktokshop','tiktokmademebuyit'];
    const cat = {
      beauty:['skincare','glowup','skinbarrier'],
      kitchen:['kitchen','mealprep','kitchenhacks'],
      cleaning:['cleantok','cleaningtips','deepclean'],
      gadgets:['gadgets','techtok','setup'],
      pets:['pettok','backyardchickens','petparents']
    }[category] || [];
    const slug = s => strip(s.toLowerCase().replace(/&/g,'and').replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,''));
    const parts = (product+' '+audience+' '+benefits.join(' ')+' '+pains.join(' ')).split(/\W+/).map(slug).filter(x=>x && x.length>2);
    const niche = Array.from(new Set(parts)).slice(0, 20);
    const picks = new Set();
    base.forEach(b => picks.add('#'+b)); cat.forEach(c => { if (picks.size<n) picks.add('#'+c); });
    niche.forEach(t => { if (picks.size<n) picks.add('#'+t); });
    return Array.from(picks).slice(0,n);
  }

  async function build(){
    const vars = readVars();
    els.status.textContent = 'Thinking…';
    els.status.style.display = 'block';

    try{
      const data = await callAI(vars);
      const tagsLine = (data.hashtags || []).map(h => h.startsWith('#') ? h : '#'+h);
      const list = [];
      if (data.combined){ list.push({ combined: data.combined, caption: data.combined, hashtags: [] }); }
      if (Array.isArray(data.captions) && data.captions.length){
        data.captions.slice(0,2).forEach(c => list.push({ caption: c, hashtags: tagsLine }));
      }
      if (!list.length){
        const fh = fallbackHashtags(vars);
        list.push({ caption: 'Paste any caption here then add:', hashtags: fh });
      }
      render(list, true);
      els.status.textContent = 'Generated ✅';
    }catch(e){
      console.warn('AI failed:', e);
      const fh = fallbackHashtags(vars);
      render([{ caption: 'AI unavailable — here is a fallback tag set:', hashtags: fh }], false);
      els.status.textContent = 'AI unavailable — fallback shown';
    }
  }

  // ========== SAFE INIT & LISTENERS ==========
  document.addEventListener('DOMContentLoaded', ()=>{
    cacheEls();
    initTheme();
    initMenu();

    // Make sure the Generate button is a real button and clickable
    if (els.generate){
      els.generate.setAttribute('type','button');
      els.generate.style.cursor = 'pointer';
      els.generate.addEventListener('click', ()=>{ saveState(); build(); });
    }

    if (els.copyAll){
      els.copyAll.setAttribute('type','button');
      els.copyAll.addEventListener('click', async ()=>{
        const boxes = Array.from(document.querySelectorAll('.cap'));
        const text = boxes.map(b=>{
          const bodies = b.querySelectorAll('.body');
          const t = bodies[0]?.textContent || '';
          const h = bodies[1]?.textContent || '';
          return h ? (t + '\n' + h).trim() : t.trim();
        }).join('\n\n');
        await copy(text); flash(`Copied ${boxes.length} item(s) ✅`);
      });
    }

    if (els.exportCsv){
      els.exportCsv.setAttribute('type','button');
      els.exportCsv.addEventListener('click', async ()=>{
        const boxes = Array.from(document.querySelectorAll('.cap'));
        const rows = boxes.map(b=>{
          const bodies = b.querySelectorAll('.body');
          const t = bodies[0]?.textContent || '';
          const h = bodies[1]?.textContent || '';
          return {caption:t, hashtags:h};
        });
        const esc = s=> `"${String(s).replace(/"/g,'""')}"`;
        const csv = 'idx,caption,hashtags\n' + rows.map((r,i)=> [i+1, esc(r.caption), esc(r.hashtags)].join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `captions_${todaySeed()}.csv`; a.click();
        URL.revokeObjectURL(a.href);
        flash('Exported CSV ✅');
      });
    }

    // Pre-fill nice defaults and set footer year
    if (!els.product.value) els.product.value = '14-in-1 Veggie Chopper';
    if (!els.category.value) els.category.value = 'kitchen';
    if (!els.audience.value) els.audience.value = 'busy parents';
    if (!els.pains.value) els.pains.value = 'spending forever chopping; cluttered counters';
    if (!els.benefits.value) els.benefits.value = '5-minute meal prep; one tool replaces 7';
    saveState();
    const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();
  });
</script>

</body>
</html>

